AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Sample SAM Template for Admin Endpoints

Mappings:
    EnvironmentMap:
      qa:
        ApiGatewayId: bjomeyg8y0
        V1Resource: mbsw8v
        AuthorizerId: 1apnn6
        OpenSearchDomain: search-ahocultural-qa-2o6wra2alh6cjmp6ycl5nzgpvy.us-east-1.es.amazonaws.com
        CdnUrl: https://qa.ahocultural.com
        VpcId: 'vpc-037d9670c525ce3b4'
        SubnetA: 'subnet-049a592833b7912e2'
        SubnetB: 'subnet-00be133ebb883899d'
        DatabaseName: 'aho'
        InstanceClass: 'db.t3.micro'  ## free tier
        EngineVersion: '8.4.6'
        AllocatedStorage: 20
        DbHost: 'rds-aho-qa.c8zgqsy8ou3j.us-east-1.rds.amazonaws.com'
        DbPort: 3306
        DbUser: 'admin'
        DbPassword: 'aB8d3F9kLm2Pq7Rt'
        DbName: 'aho'
        DbSsl: 'true'
      prod:
        ApiGatewayId: '1111'
        V1Resource: '1111'
        AuthorizerId: '1111'
        OpenSearchDomain: '1111'
Parameters:
  Environment:
    Description: Environment where stack will be deployed
    Type: String
    AllowedValues:
    - qa
    - prod
  DBUsername:
    Description: Database Username
    Type: String
    Default: admin
  DBPassword:
    Description: Database Password
    Type: String
    NoEcho: true

Globals:
  Function:
    Timeout: 15
    MemorySize: 256
    Environment:
      Variables:
        DATABASE_HOST: !FindInMap [EnvironmentMap, !Ref 'Environment', DbHost]
        DATABASE_PORT: !FindInMap [EnvironmentMap, !Ref 'Environment', DbPort]
        DATABASE_USER: !FindInMap [EnvironmentMap, !Ref 'Environment', DbUser]
        DATABASE_PASSWORD: !FindInMap [EnvironmentMap, !Ref 'Environment', DbPassword]
        DATABASE_NAME: !FindInMap [EnvironmentMap, !Ref 'Environment', DbName]
        DATABASE_SSL: !FindInMap [EnvironmentMap, !Ref 'Environment', DbSsl]

Resources:
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG do RDS MySQL
      VpcId: !FindInMap [EnvironmentMap, !Ref 'Environment', VpcId]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 179.167.223.185/32          # restrito ao IP da minha rede
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub rds-aho-${Environment}-sg

  # Subnet Group usando as duas subnets privadas informadas
  RDSSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet Group para RDS MySQL QA
      DBSubnetGroupName: !Sub rds-aho-${Environment}-subnetgrp
      SubnetIds:
        - !FindInMap [EnvironmentMap, !Ref 'Environment', SubnetA]
        - !FindInMap [EnvironmentMap, !Ref 'Environment', SubnetB]
  MySqlParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: Param group MySQL 8.0 (TLS obrigat√≥rio)
      Family: mysql8.4
      Parameters:
        character_set_server: utf8mb4
        collation_server: utf8mb4_unicode_ci
        require_secure_transport: 'ON'     # TLS

  # Instancia RDS MySQL
  MySqlInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub rds-aho-${Environment}
      Engine: mysql
      EngineVersion: !FindInMap [EnvironmentMap, !Ref 'Environment', EngineVersion]
      DBName: !FindInMap [EnvironmentMap, !Ref 'Environment', DatabaseName]
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword

      DBInstanceClass: !FindInMap [EnvironmentMap, !Ref 'Environment', InstanceClass]
      AllocatedStorage: !FindInMap [EnvironmentMap, !Ref 'Environment', AllocatedStorage]
      MaxAllocatedStorage: !FindInMap [EnvironmentMap, !Ref 'Environment', AllocatedStorage]
      StorageType: gp2
      StorageEncrypted: true
      CopyTagsToSnapshot: true

      PubliclyAccessible: true
      MultiAZ: false
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      AutoMinorVersionUpgrade: true

      DBSubnetGroupName: !Ref RDSSubnetGroup
      VPCSecurityGroups:
        - !GetAtt RDSSecurityGroup.GroupId
      DBParameterGroupName: !Ref MySqlParameterGroup
  AdminResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !FindInMap [EnvironmentMap, !Ref 'Environment', V1Resource]
      PathPart: admin
  AdminOptions:
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ResourceId: !Ref AdminResource
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'*'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
          ResponseTemplates:
            application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK

  ## Company
  CompanyResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: company
  CompanyIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      ParentId:  !Ref CompanyResource
      PathPart: '{id}'
  CompanyLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: company/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_DATABASE: !Sub ahocultural-database-${Environment}
          COMPANY_NOTIFIER: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-companies-index-${Environment}
          OPENSEARCH_ENDPOINT: !FindInMap [EnvironmentMap, !Ref Environment, OpenSearchDomain]
          COMPANY_INDEX: companies
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Statement:
          - Sid: CompanyLambdaIngestorOpenSearch
            Effect: Allow
            Action: 
              - es:*
            Resource:
              !Sub arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/ahocultural-${Environment}*
        - Statement:
            - Sid: CompanyLambdaS3Admin
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectTagging
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:DeleteObjectTagging
                - s3:ListBucket
              Resource: 
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}/*'
        - Statement:
            - Sid: CompanyLambdaSnsAdmin
              Effect: Allow
              Action:
                - sns:Publish
              Resource:
                - !Sub 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-companies-index-${Environment}'
  CompanyTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref CompanyLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/company*
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  CompanyGetByIdMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref CompanyIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CompanyLambda.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
  CompanyGetMethod:
    DependsOn: 
      - CompanyTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref CompanyResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt CompanyLambda.Arn
  CompanyPostMethod:
    DependsOn: 
      - CompanyTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref CompanyResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt CompanyLambda.Arn
  CompanyPutMethod:
    DependsOn: 
      - CompanyTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref CompanyIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt CompanyLambda.Arn
  CompanyPatchMethod:
    DependsOn: 
      - CompanyTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PATCH
      ResourceId: !Ref CompanyIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt CompanyLambda.Arn
  CompanyOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref CompanyResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  CompanyOptionsIdMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref CompanyIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Category
  CategoryResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: category
  CategoryIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      ParentId:  !Ref CategoryResource
      PathPart: '{id}'
  CategoryLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: category/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_DATABASE: !Sub ahocultural-database-${Environment}
          OPENSEARCH_ENDPOINT: !FindInMap [EnvironmentMap, !Ref Environment, OpenSearchDomain]
          CATEGORY_NOTIFIER: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-categories-index-${Environment}
          CATEGORY_INDEX: categories
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Statement:
          - Sid: CategoryLambdaIngestorOpenSearch
            Effect: Allow
            Action: 
              - es:*
            Resource:
              !Sub arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/ahocultural-${Environment}*
        - Statement:
            - Sid: CategoryLambdaS3Admin
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectTagging
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:DeleteObjectTagging
                - s3:ListBucket
              Resource: 
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}/*'
        - Statement:
            - Sid: CategoryLambdaSnsAdmin
              Effect: Allow
              Action:
                - sns:Publish
              Resource:
                - !Sub 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-categories-index-${Environment}'
  CategoryTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref CategoryLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/category*
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  CategoryGetByIdMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref CategoryIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CategoryLambda.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
  CategoryGetMethod:
    DependsOn: 
      - CategoryTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref CategoryResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt CategoryLambda.Arn
  CategoryPostMethod:
    DependsOn: 
      - CategoryTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref CategoryResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt CategoryLambda.Arn
  CategoryPutMethod:
    DependsOn: 
      - CategoryTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref CategoryIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt CategoryLambda.Arn
  CategoryPatchMethod:
    DependsOn: 
      - CategoryTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PATCH
      ResourceId: !Ref CategoryIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt CategoryLambda.Arn
  CategoryOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref CategoryResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  CategoryOptionsIdMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref CategoryIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Location
  LocationResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: location
  LocationIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      ParentId:  !Ref LocationResource
      PathPart: '{id}'
  LocationLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: location/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_DATABASE: !Sub ahocultural-database-${Environment}
          OPENSEARCH_ENDPOINT: !FindInMap [EnvironmentMap, !Ref Environment, OpenSearchDomain]
          LOCATION_NOTIFIER: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-locations-index-${Environment}
          LOCATION_INDEX: locations
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Statement:
          - Sid: LocationLambdaIngestorOpenSearch
            Effect: Allow
            Action: 
              - es:*
            Resource:
              !Sub arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/ahocultural-${Environment}*
        - Statement:
            - Sid: LocationLambdaS3Admin
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectTagging
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:DeleteObjectTagging
                - s3:ListBucket
              Resource: 
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}/*'
        - Statement:
            - Sid: LocationLambdaSnsAdmin
              Effect: Allow
              Action:
                - sns:Publish
              Resource:
                - !Sub 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-locations-index-${Environment}'
  LocationTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref LocationLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/location*
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  LocationGetByIdMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref LocationIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LocationLambda.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
  LocationGetMethod:
    DependsOn: 
      - LocationTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref LocationResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt LocationLambda.Arn
  LocationPostMethod:
    DependsOn: 
      - LocationTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref LocationResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt LocationLambda.Arn
  LocationPutMethod:
    DependsOn: 
      - LocationTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref LocationIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt LocationLambda.Arn
  LocationPatchMethod:
    DependsOn: 
      - LocationTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PATCH
      ResourceId: !Ref LocationIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt LocationLambda.Arn
  LocationOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref LocationResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  LocationOptionsIdMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref LocationIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Geo
  GeoResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: geo
  CountryResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref GeoResource
      PathPart: country
  StateResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref GeoResource
      PathPart: state
  StateIdResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref StateResource
      PathPart: '{countryId}'
  CityResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref GeoResource
      PathPart: city
  CityIdResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref CityResource
      PathPart: '{stateId}'
  GeoLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: geo/app.lambdaHandler
      Runtime: nodejs22.x
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  GeoTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref GeoLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/geo/*
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  GeoCountryGetMethod:
    DependsOn: 
      - GeoTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref CountryResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt GeoLambda.Arn
  GeoCountryOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref CountryResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  GeoStateGetMethod:
    DependsOn: 
      - GeoTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref StateIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt GeoLambda.Arn
  GeoStateOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref StateIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  GeoCityGetMethod:
    DependsOn: 
      - GeoTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref CityIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt GeoLambda.Arn
  GeoCityOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref CityIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Article
  ArticleResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: article
  ArticleIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      ParentId:  !Ref ArticleResource
      PathPart: '{id}'
  ArticleLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: article/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_DATABASE: !Sub ahocultural-database-${Environment}
          BUCKET_ASSETS: !Sub ahocultural-assets-${Environment}
          OPENSEARCH_ENDPOINT: !FindInMap [EnvironmentMap, !Ref Environment, OpenSearchDomain]
          ARTICLE_NOTIFIER: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-articles-index-${Environment}
          ARTICLE_INDEX: articles
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Statement:
          - Sid: ArticleLambdaIngestorOpenSearch
            Effect: Allow
            Action: 
              - es:*
            Resource:
              !Sub arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/ahocultural-${Environment}*
        - Statement:
            - Sid: ArticleLambdaS3Admin
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectTagging
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:DeleteObjectTagging
                - s3:ListBucket
              Resource: 
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}/*'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}/*'
        - Statement:
            - Sid: ArticleLambdaSnsAdmin
              Effect: Allow
              Action:
                - sns:Publish
              Resource:
                - !Sub 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-articles-index-${Environment}'
  ArticleTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref ArticleLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/article*
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  ArticleGetByIdMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref ArticleIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ArticleLambda.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
  ArticleGetMethod:
    DependsOn: 
      - ArticleTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref ArticleResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt ArticleLambda.Arn
  ArticlePostMethod:
    DependsOn: 
      - ArticleTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref ArticleResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt ArticleLambda.Arn
  ArticlePutMethod:
    DependsOn: 
      - ArticleTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref ArticleIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt ArticleLambda.Arn
  ArticlePatchMethod:
    DependsOn: 
      - ArticleTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PATCH
      ResourceId: !Ref ArticleIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt ArticleLambda.Arn
  ArticleOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref ArticleResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  ArticleOptionsIdMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref ArticleIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Event
  EventResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: event
  EventIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      ParentId:  !Ref EventResource
      PathPart: '{id}'
  EventLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: event/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_DATABASE: !Sub ahocultural-database-${Environment}
          BUCKET_ASSETS: !Sub ahocultural-assets-${Environment}
          OPENSEARCH_ENDPOINT: !FindInMap [EnvironmentMap, !Ref Environment, OpenSearchDomain]
          EVENT_NOTIFIER: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-events-index-${Environment}
          EVENT_INDEX: events
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Statement:
          - Sid: EventLambdaIngestorOpenSearch
            Effect: Allow
            Action: 
              - es:*
            Resource:
              !Sub arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/ahocultural-${Environment}*
        - Statement:
            - Sid: EventLambdaS3Admin
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectTagging
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:DeleteObjectTagging
                - s3:ListBucket
              Resource: 
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}/*'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}/*'
        - Statement:
            - Sid: EventLambdaSnsAdmin
              Effect: Allow
              Action:
                - sns:Publish
              Resource:
                - !Sub 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:ahocultural-events-index-${Environment}'
  EventTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref EventLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/event*
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  EventGetByIdMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref EventIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${EventLambda.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
  EventGetMethod:
    DependsOn: 
      - EventTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref EventResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt EventLambda.Arn
  EventPostMethod:
    DependsOn: 
      - EventTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref EventResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt EventLambda.Arn
  EventPutMethod:
    DependsOn: 
      - EventTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref EventIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt EventLambda.Arn
  EventPatchMethod:
    DependsOn: 
      - EventTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PATCH
      ResourceId: !Ref EventIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt EventLambda.Arn
  EventOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref EventResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  EventOptionsIdMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref EventIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## File
  FileResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: file
  FileIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      ParentId:  !Ref FileResource
      PathPart: '{id}'
  FileLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: file/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_ASSETS: !Sub ahocultural-assets-${Environment}
          CDN_BASE_URL: !FindInMap [EnvironmentMap, !Ref Environment, CdnUrl]
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Statement:
            - Sid: FileLambdaS3Admin
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectTagging
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:DeleteObjectTagging
                - s3:ListBucket
              Resource: 
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}/*'
  FileTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref FileLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/file*
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  FileGetByIdMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref FileIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FileLambda.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
  FileOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref FileResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  FileOptionsIdMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref FileIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  FilePreSignedUrlMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref FileResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FileLambda.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500

  ## About
  AboutResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: about
  AboutLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: about/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_DATABASE: !Sub ahocultural-database-${Environment}
          BUCKET_ASSETS: !Sub ahocultural-assets-${Environment}
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Statement:
            - Sid: AboutLambdaS3Admin
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectTagging
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:DeleteObjectTagging
                - s3:ListBucket
              Resource: 
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}/*'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}/*'
  AboutTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref AboutLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/about
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  AboutGetMethod:
    DependsOn: 
      - AboutTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref AboutResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AboutLambda.Arn
  AboutPostMethod:
    DependsOn: 
      - AboutTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref AboutResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AboutLambda.Arn
  AboutPutMethod:
    DependsOn: 
      - AboutTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref AboutResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AboutLambda.Arn
  AboutOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref AboutResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Advertisement
  AdvertisementResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: advertisement
  AdvertisementLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: advertisement/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_DATABASE: !Sub ahocultural-database-${Environment}
          BUCKET_ASSETS: !Sub ahocultural-assets-${Environment}
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Statement:
            - Sid: AdvertisementLambdaS3Admin
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectTagging
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:DeleteObjectTagging
                - s3:ListBucket
              Resource: 
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-database-${Environment}/*'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}'
                - !Sub 'arn:aws:s3:::ahocultural-assets-${Environment}/*'
  AdvertisementTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref AdvertisementLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/advertisement
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  AdvertisementGetMethod:
    DependsOn: 
      - AdvertisementTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref AdvertisementResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AdvertisementLambda.Arn
  AdvertisementPostMethod:
    DependsOn: 
      - AdvertisementTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref AdvertisementResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AdvertisementLambda.Arn
  AdvertisementPutMethod:
    DependsOn: 
      - AdvertisementTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref AdvertisementResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AdvertisementLambda.Arn
  AdvertisementOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref AdvertisementResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Contact
  ContactResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: contact
  ContactLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: contact/app.lambdaHandler
      Runtime: nodejs22.x
      Environment:
        Variables:
          BUCKET_DATABASE: !Sub ahocultural-database-${Environment}
          BUCKET_ASSETS: !Sub ahocultural-assets-${Environment}
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  ContactTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref ContactLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/contact
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  ContactGetMethod:
    DependsOn: 
      - ContactTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref ContactResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt ContactLambda.Arn
  ContactPostMethod:
    DependsOn: 
      - ContactTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref ContactResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt ContactLambda.Arn
  ContactPutMethod:
    DependsOn: 
      - ContactTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref ContactResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt ContactLambda.Arn
  ContactOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref ContactResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Studio
  StudioResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: studio
  StudioLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: studio/app.lambdaHandler
      Runtime: nodejs22.x
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  StudioTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref StudioLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/studio
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  StudioGetMethod:
    DependsOn: 
      - StudioTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref StudioResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt StudioLambda.Arn
  StudioPostMethod:
    DependsOn: 
      - StudioTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref StudioResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt StudioLambda.Arn
  StudioPutMethod:
    DependsOn: 
      - StudioTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref StudioResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt StudioLambda.Arn
  StudioOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref StudioResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Ad
  AdResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      ParentId: !Ref AdminResource
      PathPart: ad
  AdIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      ParentId:  !Ref AdResource
      PathPart: '{id}'
  AdLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .dist/
      Handler: ad/app.lambdaHandler
      Runtime: nodejs22.x
      Policies: 
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  AdTrigger:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:invokeFunction'
      FunctionName: !Ref AdLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayId}/*/*/v1/admin/ad*
        - ApiGatewayId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
  AdGetByIdMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref AdIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref Environment, ApiGatewayId]
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdLambda.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
  AdGetMethod:
    DependsOn: 
      - AdTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: GET
      ResourceId: !Ref AdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AdLambda.Arn
  AdPostMethod:
    DependsOn: 
      - AdTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: POST
      ResourceId: !Ref AdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AdLambda.Arn
  AdPutMethod:
    DependsOn: 
      - AdTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PUT
      ResourceId: !Ref AdIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AdLambda.Arn
  AdPatchMethod:
    DependsOn: 
      - AdTrigger
    Type: 'AWS::ApiGateway::Method'
    Properties: 
      AuthorizationType: CUSTOM
      AuthorizerId: !FindInMap [EnvironmentMap, !Ref 'Environment', AuthorizerId]
      HttpMethod: PATCH
      ResourceId: !Ref AdIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 204
        - StatusCode: 302
        - StatusCode: 400
        - StatusCode: 401
        - StatusCode: 500
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations
          - LambdaArn: !GetAtt AdLambda.Arn
  AdOptionsMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref AdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true
  AdOptionsIdMethod:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      ResourceId: !Ref AdIdResource
      RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Headers: true

  ## Deployment
  ApiGatewayDeployment:
      Type: 'AWS::ApiGateway::Deployment'
      DependsOn:
        - CompanyGetByIdMethod
        - CompanyGetMethod
        - CompanyPostMethod
        - CompanyPutMethod
        - CompanyPatchMethod
        - CompanyOptionsMethod
        - CompanyOptionsIdMethod
        - CategoryGetByIdMethod
        - CategoryGetMethod
        - CategoryPostMethod
        - CategoryPutMethod
        - CategoryPatchMethod
        - CategoryOptionsMethod
        - CategoryOptionsIdMethod
        - LocationGetByIdMethod
        - LocationGetMethod
        - LocationPostMethod
        - LocationPutMethod
        - LocationPatchMethod
        - LocationOptionsMethod
        - LocationOptionsIdMethod
        - ArticleGetByIdMethod
        - ArticleGetMethod
        - ArticlePostMethod
        - ArticlePutMethod
        - ArticlePatchMethod
        - ArticleOptionsMethod
        - ArticleOptionsIdMethod
        - EventGetByIdMethod
        - EventGetMethod
        - EventPostMethod
        - EventPutMethod
        - EventPatchMethod
        - EventOptionsMethod
        - EventOptionsIdMethod
        - FileGetByIdMethod
        - FileOptionsMethod
        - FileOptionsIdMethod
        - FilePreSignedUrlMethod
        - AboutGetMethod
        - AboutPostMethod
        - AboutPutMethod
        - AboutOptionsMethod
        - AdvertisementGetMethod
        - AdvertisementPostMethod
        - AdvertisementPutMethod
        - AdvertisementOptionsMethod
      Properties:
        RestApiId: !FindInMap [EnvironmentMap, !Ref 'Environment', ApiGatewayId]
        StageName: !Ref Environment

Outputs:
  RDSEndpoint:
    Description: Endpoint do MySQL
    Value: !GetAtt MySqlInstance.Endpoint.Address
  RDSPort:
    Description: Porta do MySQL
    Value: !GetAtt MySqlInstance.Endpoint.Port
  RdsSecurityGroupId:
    Description: Security Group do RDS
    Value: !Ref RDSSecurityGroup
  RdsSubnetGroupName:
    Description: DB Subnet Group
    Value: !Ref RDSSubnetGroup